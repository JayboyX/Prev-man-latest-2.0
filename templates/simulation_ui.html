<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailTrack Pro - Simulation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            transition: all 0.3s ease;
            width: 250px;
        }
        .sidebar-collapsed {
            width: 80px;
        }
        .main-content {
            transition: all 0.3s ease;
            margin-left: 250px;
        }
        .main-content-expanded {
            margin-left: 80px;
        }
        .nav-item.active {
            background-color: #1e40af;
            border-left: 4px solid #93c5fd;
        }
        .log-entry {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Sidebar Navigation -->
    <div class="sidebar bg-gray-900 text-gray-100 h-screen fixed shadow-lg">
        <div class="p-5 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center">
                <i class="fas fa-train text-blue-400 text-2xl mr-3"></i>
                <h1 class="text-xl font-bold">RailTrack Pro</h1>
            </div>
            <button id="toggleSidebar" class="text-gray-400 hover:text-white">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <nav class="mt-6">
            <div class="px-4">
                <p class="text-gray-400 uppercase text-xs font-semibold mb-3">Main</p>
                <a href="/" class="nav-item flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 rounded transition">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="/" class="nav-item active flex items-center py-3 px-4 text-white hover:bg-gray-800 rounded transition">
                    <i class="fas fa-cogs mr-3"></i>
                    <span class="nav-text">Simulation</span>
                </a>
                <a href="/analytics_dashboard" class="nav-item flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 rounded transition">
                    <i class="fas fa-chart-line mr-3"></i>
                    <span class="nav-text">Analytics</span>
                </a>
            </div>
            
            <div class="px-4 mt-6">
                <p class="text-gray-400 uppercase text-xs font-semibold mb-3">Tools</p>
                <a href="/visualization" class="nav-item flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 rounded transition">
                    <i class="fas fa-project-diagram mr-3"></i>
                    <span class="nav-text">Visualization</span>
                </a>
                <a href="/reports" class="nav-item flex items-center py-3 px-4 text-gray-300 hover:bg-gray-800 rounded transition">
                    <i class="fas fa-file-alt mr-3"></i>
                    <span class="nav-text">Reports</span>
                </a>
            </div>
        </nav>
        
        <div class="absolute bottom-0 w-full p-4 border-t border-gray-700">
            <div class="flex items-center">
                <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                    <span class="text-white font-bold">AD</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium">Admin User</p>
                    <p class="text-xs text-gray-400">Administrator</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="flex justify-between items-center py-4 px-6">
                <h2 class="text-xl font-semibold text-gray-800">Rail Simulation</h2>
                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full hover:bg-gray-100">
                        <i class="fas fa-bell text-gray-500"></i>
                    </button>
                    <button class="p-2 rounded-full hover:bg-gray-100">
                        <i class="fas fa-question-circle text-gray-500"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="p-6">
            <!-- Simulation Control Panel -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Simulation Parameters</h3>
                    <div class="flex space-x-3">
                        <button onclick="randomizeInputs()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition flex items-center">
                            <i class="fas fa-random mr-2"></i> Randomize
                        </button>
                        <button onclick="calculateDistance()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition flex items-center">
                            <i class="fas fa-calculator mr-2"></i> Calculate Distance
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Simulation Date</label>
                        <input type="date" id="simulation_date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Point</label>
                        <select id="start_point" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            {% for checkpoint in checkpoints %}
                            <option value="{{ checkpoint }}">{{ checkpoint }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Point</label>
                        <select id="end_point" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            {% for checkpoint in checkpoints %}
                            <option value="{{ checkpoint }}">{{ checkpoint }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Train Model</label>
                        <select id="train_id" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="Train A">Train A (Lightweight, High Speed)</option>
                            <option value="Train B">Train B (Medium Weight, Moderate Speed)</option>
                            <option value="Train C">Train C (Heavyweight, Low Speed)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Speed Gain</label>
                        <input type="number" id="speed_gain" min="0.1" step="0.1" value="1.0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Weight Gain</label>
                        <input type="number" id="weight_gain" min="0.1" step="0.1" value="1.0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Frequency Gain</label>
                        <input type="number" id="frequency_gain" min="0.1" step="0.1" value="1.0" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div class="flex items-end">
                        <div class="w-full">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Distance</label>
                            <div id="distance_display" class="p-2 bg-gray-50 rounded-md text-gray-700 font-medium">
                                Not calculated yet
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end space-x-4">
                    <button onclick="resetForm()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition font-medium flex items-center">
                        <i class="fas fa-undo mr-2"></i> Reset
                    </button>
                    <button onclick="runSimulation()" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition font-medium flex items-center">
                        <i class="fas fa-play mr-2"></i> Run Simulation
                    </button>
                    <button id="view-visualization-btn" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition font-medium flex items-center" disabled>
                        <i class="fas fa-chart-bar mr-2"></i> View Visualization
                    </button>
                </div>
            </div>
            
            <!-- Logs Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Simulation Logs</h3>
                    <div class="flex space-x-2">
                        <button onclick="clearLogs()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button onclick="exportLogs()" class="p-2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div id="logs" class="h-64 overflow-y-auto p-3 bg-gray-50 rounded-md border border-gray-200"></div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let checkpointDistances = {};
        let currentSimulationId = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('simulation_date').value = today;
            
            // Fetch checkpoint distances
            fetchCheckpointDistances();
            
            // Initialize sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // Initialize view visualization button
            document.getElementById('view-visualization-btn').addEventListener('click', viewVisualization);
            
            // Log initialization
            addLog('System initialized', 'info');
        });
        
        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            sidebar.classList.toggle('sidebar-collapsed');
            mainContent.classList.toggle('main-content-expanded');
            
            // Toggle nav text visibility
            document.querySelectorAll('.nav-text').forEach(el => {
                el.classList.toggle('hidden');
            });
        }
        
        // Fetch checkpoint distances from backend
        function fetchCheckpointDistances() {
            addLog('Loading checkpoint distances...', 'info');
            
            fetch('/get_checkpoint_distances')
                .then(response => response.json())
                .then(data => {
                    data.forEach(cp => {
                        checkpointDistances[cp.name] = cp.distance_from_start;
                    });
                    addLog('Checkpoint distances loaded successfully', 'success');
                })
                .catch(error => {
                    addLog('Failed to load checkpoint distances: ' + error.message, 'error');
                });
        }
        
        // Calculate distance between selected checkpoints
        function calculateDistance() {
            const startPoint = document.getElementById('start_point').value;
            const endPoint = document.getElementById('end_point').value;
            
            if (!checkpointDistances[startPoint] || !checkpointDistances[endPoint]) {
                addLog('Checkpoint distances not loaded yet', 'warning');
                return;
            }
            
            const startDist = checkpointDistances[startPoint];
            const endDist = checkpointDistances[endPoint];
            const distance = Math.abs(endDist - startDist);
            
            document.getElementById('distance_display').innerHTML = `
                <span class="font-bold">${distance.toFixed(1)} km</span>
                <span class="text-sm text-gray-500">from ${startPoint} to ${endPoint}</span>
            `;
            
            addLog(`Calculated distance: ${distance.toFixed(1)} km between ${startPoint} and ${endPoint}`, 'info');
        }
        
        // Run simulation
        function runSimulation() {
            // Get all input values
            const simulationDate = document.getElementById('simulation_date').value;
            const startPoint = document.getElementById('start_point').value;
            const endPoint = document.getElementById('end_point').value;
            const trainId = document.getElementById('train_id').value;
            const speedGain = document.getElementById('speed_gain').value;
            const weightGain = document.getElementById('weight_gain').value;
            const frequencyGain = document.getElementById('frequency_gain').value;
            
            // Validate inputs
            if (!simulationDate || !startPoint || !endPoint || !trainId || 
                !speedGain || !weightGain || !frequencyGain) {
                addLog('Please fill in all fields', 'error');
                return;
            }
            
            if (startPoint === endPoint) {
                addLog('Start and end points cannot be the same', 'error');
                return;
            }
            
            // Calculate distance if not already calculated
            if (document.getElementById('distance_display').textContent === 'Not calculated yet') {
                calculateDistance();
            }
            
            // Show loading state
            const runBtn = document.querySelector('button[onclick="runSimulation()"]');
            runBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Running...';
            runBtn.disabled = true;
            
            addLog('Starting simulation...', 'info');
            
            // Send request to backend
            fetch('/run_simulation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    simulation_date: simulationDate,
                    start_point: startPoint,
                    end_point: endPoint,
                    train_id: trainId,
                    speed_gain: parseFloat(speedGain),
                    weight_gain: parseFloat(weightGain),
                    frequency_gain: parseFloat(frequencyGain)
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server returned error status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Store simulation ID
                currentSimulationId = data.simulation_id;
                
                // Enable visualization button
                const vizBtn = document.getElementById('view-visualization-btn');
                vizBtn.disabled = false;
                vizBtn.onclick = function() {
                    window.location.href = `/visualization?simulation_id=${currentSimulationId}`;
                };
                
                addLog('Simulation completed successfully!', 'success');
                addLog(`Simulation ID: ${data.simulation_id}`, 'info');
                addLog('Click "View Visualization" to see the results', 'info');
            })
            .catch(error => {
                console.error('Error:', error);
                addLog('Simulation failed: ' + error.message, 'error');
            })
            .finally(() => {
                // Re-enable button
                runBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Run Simulation';
                runBtn.disabled = false;
            });
        }
        
        // View visualization
    // View visualization - Modified to pass the simulation ID
    function viewVisualization() {
        if (!currentSimulationId) {
            addLog('Please run a simulation first before viewing visualization', 'warning');
            return;
        }
        // Store the simulation ID in sessionStorage before navigating
        sessionStorage.setItem('lastSimulationId', currentSimulationId);
        window.location.href = '/visualization';
    }
        
        // Randomize inputs
        function randomizeInputs() {
            document.getElementById('speed_gain').value = (Math.random() * 2 + 0.1).toFixed(1);
            document.getElementById('weight_gain').value = (Math.random() * 2 + 0.1).toFixed(1);
            document.getElementById('frequency_gain').value = (Math.random() * 2 + 0.1).toFixed(1);
            
            // Randomly select different start and end points
            const checkpoints = Array.from(document.getElementById('start_point').options);
            const startIdx = Math.floor(Math.random() * checkpoints.length);
            let endIdx;
            do {
                endIdx = Math.floor(Math.random() * checkpoints.length);
            } while (endIdx === startIdx);
            
            document.getElementById('start_point').selectedIndex = startIdx;
            document.getElementById('end_point').selectedIndex = endIdx;
            
            // Reset distance display
            document.getElementById('distance_display').textContent = 'Not calculated yet';
            
            addLog('Randomized simulation parameters', 'info');
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('simulation_date').valueAsDate = new Date();
            document.getElementById('start_point').selectedIndex = 0;
            document.getElementById('end_point').selectedIndex = 1;
            document.getElementById('train_id').selectedIndex = 0;
            document.getElementById('speed_gain').value = '1.0';
            document.getElementById('weight_gain').value = '1.0';
            document.getElementById('frequency_gain').value = '1.0';
            document.getElementById('distance_display').textContent = 'Not calculated yet';
            
            // Disable visualization button
            document.getElementById('view-visualization-btn').disabled = true;
            currentSimulationId = null;
            
            addLog('Form reset to default values', 'info');
        }
        
        // Clear logs
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            addLog('Logs cleared', 'info');
        }
        
        // Export logs
        function exportLogs() {
            const logs = document.getElementById('logs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `simulation_logs_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('Logs exported', 'success');
        }
        
        // Add log entry
        function addLog(message, type = 'info') {
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-yellow-600'
            };
            const icons = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `log-entry mb-2 ${colors[type]} flex items-start`;
            logElement.innerHTML = `
                <i class="fas ${icons[type]} mt-1 mr-2"></i>
                <div>
                    <span class="font-medium">[${timestamp}]</span> ${message}
                </div>
            `;
            document.getElementById('logs').appendChild(logElement);
            
            // Auto-scroll to bottom
            const logsContainer = document.getElementById('logs');
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    </script>
</body>
</html>